#!/bin/sh

PIGLIT_DIR=$1
BASE_DIR="$(cd "$(dirname "$0")"; pwd -P)"
EXCLUDE_FILE="$BASE_DIR/sync-exclude"

[ -z "$PIGLIT_DIR" ] && {
	echo "Error: You must specify the piglit directory to sync from"
	exit 1
}

cat <<EOF > $EXCLUDE_FILE
tests
*.pyc
*_test.py
EOF

rsync -rtv --exclude-from $EXCLUDE_FILE	\
	$PIGLIT_DIR/framework		\
	$PIGLIT_DIR/templates		\
	$PIGLIT_DIR/piglit-*.py		\
	$BASE_DIR

files=$(cd $BASE_DIR && find .			\
		-not -type d 			\
		-not -name "*.pyc" 		\
		-not -name "*.sw?" 		\
		-not -name sync-exclude		\
		-not -name "Makefile*" |	\
		grep -v -e "^.$" |		\
		sed -e 's#^\./##')
for f in $files; do
	FILE_LIST="\t$f \\
$FILE_LIST"
done

cat <<EOF > $BASE_DIR/Makefile.am
# This file is generated, do not edit"
EXTRA_DIST = \\
EOF
echo -n -e "$FILE_LIST" >> $BASE_DIR/Makefile.am
echo -e "\t\$(NULL)"  >> $BASE_DIR/Makefile.am

rm -f $EXCLUDE_FILE
